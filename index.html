<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Regalo Navide√±o üéÑ</title>

  <style>
    :root{
      --bg:#1f2428;
      --panel:#0b0f14;
      --green:#00ff00;
      --red:#ff2a2a;
      --blue:#00b7ff;
      --yellow:#ffd200;
      --orange:#ff8a00;
      --text:#e8e8e8;
      --muted:#aeb7c2;
      --border:#273140;
      --card:#0f1622;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      background:var(--panel);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color:var(--text);
    }
    .wrap{ width:min(900px, 100%); display:flex; flex-direction:column; gap:12px; }
    .top{
      width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--card);
    }
    .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .dots{ display:flex; gap:8px; }
    .dot{ width:10px;height:10px;border-radius:50%; }
    .redDot{ background:#ff5f57; } .yellowDot{ background:#febc2e; } .greenDot{ background:#28c840; }
    .title{ font-size:13px; opacity:.9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:55vw; }

    button{
      appearance:none; border:1px solid var(--border); background:#162234; color:var(--text);
      padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer;
      display:flex; align-items:center; gap:8px; touch-action:manipulation;
    }
    button:active{ transform:scale(.99); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .hint{ width:100%; font-size:12px; color:var(--muted); text-align:center; }

    .screen{
      width:100%; background:var(--bg); border:1px solid var(--border); border-radius:12px;
      padding:14px; box-shadow:0 16px 40px rgba(0,0,0,.35);
    }
    .log{
      font-size: clamp(12px, 3.2vw, 16px);
      line-height:1.25;
      white-space:pre-wrap;
      text-align:left;
      margin:0;
      min-height: 4.2em;
    }
    .treeWrap{ display:flex; justify-content:center; width:100%; padding-top:10px; }
    .tree{
      display:inline-block;
      font-size: clamp(13px, 3.6vw, 20px);
      line-height:1.05;
      white-space:pre;
      text-align:center;
      margin:0;
      overflow:auto;
      max-height: 58svh;
      padding-bottom:6px;
      user-select:none;
    }

    .g{ color:var(--green); } .r{ color:var(--red); } .b{ color:var(--blue); } .y{ color:var(--yellow); } .o{ color:var(--orange); }

    .footerRow{
      width:100%; display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; padding:0 4px;
    }
    .small{ font-size:12px; color:var(--muted); }
    .toggle{ display:flex; align-items:center; gap:8px; user-select:none; margin-left:auto; }
    input[type="checkbox"]{ width:18px;height:18px; accent-color:#6aa9ff; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="left">
        <div class="dots">
          <span class="dot redDot"></span>
          <span class="dot yellowDot"></span>
          <span class="dot greenDot"></span>
        </div>
        <div class="title">navidad.exe ‚Äî consola</div>
      </div>
      <button id="runBtn">‚ñ∂ RUN</button>
    </div>

    <div class="hint" id="hintText">Presiona <b>RUN</b> para iniciar üéÑ</div>

    <div class="screen">
      <div id="log" class="log"></div>
      <div class="treeWrap">
        <div id="tree" class="tree"></div>
      </div>
    </div>

    <div class="footerRow">
      <div class="small">Tip: Si no escuchas m√∫sica, revisa el volumen del celular.</div>
      <label class="toggle small">
        <input id="musicToggle" type="checkbox" checked />
        M√∫sica (on/off)
      </label>
    </div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const YEAR = "2025";
  const FINAL_LINE_1 = "MERRY CHRISTMAS";
  const FINAL_LINE_2 = `And lots of CODE in ${YEAR}`;

  const CHAR_DELAY_MS = 10;
  const LINE_PAUSE_MS = 70;

  // √Årbol (tri√°ngulo is√≥sceles)
  const TREE_HEIGHT = 12;
  const TRUNK_HEIGHT = 2;

  // =========================
  // HELPERS
  // =========================
  const ornamentColors = ["b","r","y","o"];
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function esc(s){
    return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
            .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function logLine(s){
    const log = document.getElementById("log");
    log.textContent += (log.textContent ? "\n" : "") + s;
  }
  function centerLine(text, width){
    if(text.length >= width) return text;
    const pad = Math.floor((width - text.length)/2);
    return " ".repeat(pad) + text + " ".repeat(width - pad - text.length);
  }
  function rightMostNonSpaceIndex(s){
    for(let i=s.length-1;i>=0;i--) if(s[i] !== " ") return i;
    return -1;
  }

  // =========================
  // √ÅRBOL is√≥sceles + TRONCO centrado sobre BASE REAL (marca azul)
  // =========================
  function buildTreeLines(h){
    const width = 2*h - 1;
    const lines = [];

    // estrella
    lines.push(centerLine("^", width));

    // copa
    for(let i=1;i<=h;i++){
      const leafCount = 2*i - 1;
      const spaces = (width - leafCount) / 2;

      let row = " ".repeat(spaces);
      for(let k=0;k<leafCount;k++){
        const pick = (i*13 + k*7) % 12;
        row += (pick === 0 || pick === 5) ? "o" : "*";
      }
      row += " ".repeat(spaces);
      lines.push(row);
    }

    // tronco centrado al centro "real" de la base visible
    const baseLine = lines[lines.length - 1];
    const left = baseLine.search(/\S/);
    const right = rightMostNonSpaceIndex(baseLine);
    const safeLeft = (left === -1) ? 0 : left;
    const safeRight = (right === -1) ? (baseLine.length - 1) : right;
    const baseCenter = Math.floor((safeLeft + safeRight) / 2);

    const trunkStr = "mWm";
    const trunkStart = baseCenter - Math.floor(trunkStr.length / 2);

    for(let t=0;t<TRUNK_HEIGHT;t++){
      const row = Array(baseLine.length).fill(" ");
      for(let i=0;i<trunkStr.length;i++){
        const idx = trunkStart + i;
        if(idx >= 0 && idx < row.length) row[idx] = trunkStr[i];
      }
      lines.push(row.join(""));
    }

    lines.push("");
    lines.push(centerLine(FINAL_LINE_1, width));
    lines.push(centerLine(FINAL_LINE_2, width));

    return lines;
  }

  function colorChar(ch, i, lineIndex, wholeLine){
    if(wholeLine.includes(FINAL_LINE_1) || wholeLine.includes(FINAL_LINE_2)) return "r";
    if(ch === "^") return "y";
    if(ch === "*") return "g";
    if(ch === "o") return ornamentColors[(i + lineIndex*3) % ornamentColors.length];
    if("mW".includes(ch)) return "y";
    return null;
  }

  async function typeTreeLine(line, lineIndex){
    const tree = document.getElementById("tree");
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      const cls = colorChar(ch, i, lineIndex, line);
      const safeChar = (ch === " ") ? "&nbsp;" : esc(ch);
      tree.innerHTML += cls ? `<span class="${cls}">${safeChar}</span>` : safeChar;
      await sleep(CHAR_DELAY_MS);
    }
    tree.innerHTML += "<br/>";
  }

  // =========================
  // AUDIO (10s) por c√≥digo: progresi√≥n B / Bmaj7 / F# / E @ 107 bpm
  // =========================
  let audioCtx = null, master = null, stopTimer = null;

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      master = audioCtx.createGain();
      master.gain.value = 0.10; // volumen suave
      master.connect(audioCtx.destination);
    }
  }
  function stopRoma(){
    if(stopTimer) clearTimeout(stopTimer);
    stopTimer = null;
    try{
      if(master && audioCtx){
        master.gain.cancelScheduledValues(audioCtx.currentTime);
        master.gain.setTargetAtTime(0.0001, audioCtx.currentTime, 0.03);
      }
    }catch(e){}
  }
  function m2f(m){ return 440 * Math.pow(2, (m-69)/12); }

  function pluck(midi, when, dur, amp=0.14){
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "triangle";
    osc.frequency.setValueAtTime(m2f(midi), when);

    gain.gain.setValueAtTime(0.0001, when);
    gain.gain.exponentialRampToValueAtTime(amp, when + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, when + dur);

    osc.connect(gain);
    gain.connect(master);

    osc.start(when);
    osc.stop(when + dur + 0.02);
  }

  function bell(midi, when, dur, amp=0.06){
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(m2f(midi), when);

    gain.gain.setValueAtTime(0.0001, when);
    gain.gain.exponentialRampToValueAtTime(amp, when + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, when + dur);

    osc.connect(gain);
    gain.connect(master);

    osc.start(when);
    osc.stop(when + dur + 0.02);
  }

  function arp(chord, start, step, count){
    for(let i=0;i<count;i++){
      pluck(chord[i % chord.length], start + i*step, step*0.95, 0.13);
    }
  }

  function playRoma10s(){
    const toggle = document.getElementById("musicToggle");
    if(!toggle.checked) return;

    ensureAudio();
    if(audioCtx.state === "suspended") audioCtx.resume();

    stopRoma();
    master.gain.setTargetAtTime(0.10, audioCtx.currentTime, 0.02);

    const bpm = 107;
    const beat = 60 / bpm;
    const step = beat / 2;
    const start = audioCtx.currentTime + 0.06;

    const B     = [59, 63, 66, 71]; // B3 D#4 F#4 B4
    const Bmaj7 = [59, 63, 66, 70]; // B3 D#4 F#4 A#4
    const Fsh   = [54, 58, 61, 66]; // F#3 A#3 C#4 F#4
    const E     = [52, 56, 59, 64]; // E3 G#3 B3 E4

    const prog = [B, Bmaj7, Fsh, E, B, Bmaj7, Fsh, E];
    let t = start;

    for(const ch of prog){
      arp(ch, t, step, 8);
      bell(ch[3], t + step*2, 0.12, 0.05);
      bell(ch[2], t + step*6, 0.10, 0.045);

      t += beat * 4; // 1 comp√°s
      if(t - start >= 10) break;
    }

    stopTimer = setTimeout(stopRoma, 10000);
  }

  document.getElementById("musicToggle").addEventListener("change", (e) => {
    if(!e.target.checked) stopRoma();
  });

  // =========================
  // RUN (con manejo de errores visible y bot√≥n siempre vuelve)
  // =========================
  async function run(){
    const btn = document.getElementById("runBtn");
    const hint = document.getElementById("hintText");
    const tree = document.getElementById("tree");
    const log = document.getElementById("log");

    btn.disabled = true;

    try{
      hint.textContent = "Ejecutando‚Ä¶ ‚ú®";
      tree.innerHTML = "";
      log.textContent = "";

      logLine("> RUN pressed ‚úÖ");
      logLine("> initializing christmas_tree.exe");
      await sleep(200);
      logLine("> compiling magic...");
      await sleep(200);
      logLine("> rendering tree...");
      await sleep(250);

      const lines = buildTreeLines(TREE_HEIGHT);
      for(let i=0;i<lines.length;i++){
        await typeTreeLine(lines[i], i);
        await sleep(LINE_PAUSE_MS);
      }

      hint.textContent = "üéÅ Listo. Feliz Navidad.";
    }catch(err){
      hint.textContent = "‚ö†Ô∏è Ocurri√≥ un error.";
      logLine("");
      logLine("ERROR:");
      logLine(String(err && err.stack ? err.stack : err));
    }finally{
      btn.disabled = false;
    }
  }

  document.getElementById("runBtn").addEventListener("click", () => {
    playRoma10s(); // ‚úÖ audio 10s sin YouTube
    run();
  });
</script>
</body>
</html>
