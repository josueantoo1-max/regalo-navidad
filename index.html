<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Regalo Navide√±o üéÑ</title>

  <style>
    :root{
      --bg:#1f2428;
      --panel:#0b0f14;
      --green:#00ff00;
      --red:#ff2a2a;
      --blue:#00b7ff;
      --yellow:#ffd200;
      --orange:#ff8a00;
      --text:#e8e8e8;
      --muted:#aeb7c2;
      --border:#273140;
      --card:#0f1622;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      background:var(--panel);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color:var(--text);
    }

    .wrap{
      width:min(900px, 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .top{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card);
    }

    .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .dots{ display:flex; gap:8px; }
    .dot{ width:10px;height:10px;border-radius:50%; }
    .redDot{ background:#ff5f57; }
    .yellowDot{ background:#febc2e; }
    .greenDot{ background:#28c840; }

    .title{
      font-size:13px; opacity:.9;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:55vw;
    }

    button{
      appearance:none;
      border:1px solid var(--border);
      background:#162234;
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      touch-action:manipulation;
    }
    button:active{ transform:scale(.99); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .hint{
      width:100%;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    .screen{
      width:100%;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      box-shadow:0 16px 40px rgba(0,0,0,.35);
    }

    .log{
      font-size: clamp(12px, 3.2vw, 16px);
      line-height:1.25;
      white-space:pre-wrap;
      text-align:left;
      margin:0;
      min-height: 4.2em;
    }

    .treeWrap{
      display:flex;
      justify-content:center;
      width:100%;
      padding-top:10px;
    }

    /* ‚úÖ Centro real: inline-block dentro de flex center */
    .tree{
      display:inline-block;
      font-size: clamp(13px, 3.6vw, 20px);
      line-height:1.05;
      white-space:pre;
      text-align:center;
      margin:0;
      overflow:auto;
      max-height: 58svh;
      padding-bottom:6px;
      user-select:none;
    }

    .g{ color:var(--green); }
    .r{ color:var(--red); }
    .b{ color:var(--blue); }
    .y{ color:var(--yellow); }
    .o{ color:var(--orange); }

    .footerRow{
      width:100%;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding:0 4px;
    }
    .small{ font-size:12px; color:var(--muted); }
    .toggle{ display:flex; align-items:center; gap:8px; user-select:none; margin-left:auto; }
    input[type="checkbox"]{ width:18px;height:18px; accent-color:#6aa9ff; }

    .audioAlert{
      margin-top:10px;
      padding:10px 12px;
      border:1px dashed var(--border);
      border-radius:12px;
      background:#0c121c;
      color:var(--muted);
      font-size:12px;
      display:none;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .audioAlert strong{ color:var(--text); }
    .audioAlert .btnRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .audioAlert a{
      color:var(--text);
      text-decoration:none;
      border:1px solid var(--border);
      padding:8px 10px;
      border-radius:10px;
      background:#162234;
      font-weight:700;
    }

    /* YouTube player oculto */
    #ytWrap{ position:absolute; width:1px; height:1px; overflow:hidden; left:-9999px; top:-9999px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="left">
        <div class="dots">
          <span class="dot redDot"></span>
          <span class="dot yellowDot"></span>
          <span class="dot greenDot"></span>
        </div>
        <div class="title">navidad.exe ‚Äî consola</div>
      </div>
      <button id="runBtn">‚ñ∂ RUN</button>
    </div>

    <div class="hint" id="hintText">Presiona <b>RUN</b> para iniciar üéÑ</div>

    <div class="screen">
      <div id="log" class="log"></div>

      <div class="treeWrap">
        <div id="tree" class="tree"></div>
      </div>

      <div id="audioAlert" class="audioAlert">
        <div>
          <strong>Audio bloqueado por el navegador.</strong><br>
          Abre el audio en YouTube o desactiva bloqueo/seguimiento para este sitio.
        </div>
        <div class="btnRow">
          <a id="ytOpen" href="#" target="_blank" rel="noopener">Abrir en YouTube</a>
          <a id="retryAudio" href="#">Reintentar</a>
        </div>
      </div>
    </div>

    <div class="footerRow">
      <div class="small">Tip: En Firefox/Safari puede bloquearse el audio embebido. RUN lo intenta igual.</div>
      <label class="toggle small">
        <input id="musicToggle" type="checkbox" checked />
        M√∫sica (on/off)
      </label>
    </div>
  </div>

  <div id="ytWrap"><div id="ytplayer"></div></div>
  <script src="https://www.youtube.com/iframe_api"></script>

<script>
  // =========================
  // 1) PERSONALIZA
  // =========================
  const YEAR = "2025";
  const FINAL_LINE_1 = "MERRY CHRISTMAS";
  const FINAL_LINE_2 = `And lots of CODE in ${YEAR}`;

  const CHAR_DELAY_MS = 10;
  const LINE_PAUSE_MS = 70;

  // YouTube 10s
  const YT_VIDEO_ID = "TcSk5ulP-hA";
  const MUSIC_START_S = 0;
  const MUSIC_END_S = 10;

  // √Årbol (tri√°ngulo is√≥sceles)
  const TREE_HEIGHT = 12;
  const TRUNK_HEIGHT = 2;

  // =========================
  // 2) Helpers render
  // =========================
  const ornamentColors = ["b","r","y","o"];
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function esc(s){
    return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
            .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function logLine(s){
    const log = document.getElementById("log");
    log.textContent += (log.textContent ? "\n" : "") + s;
  }

  function centerLine(text, width){
    if(text.length >= width) return text;
    const pad = Math.floor((width - text.length)/2);
    return " ".repeat(pad) + text + " ".repeat(width - pad - text.length);
  }

  function rightMostNonSpaceIndex(s){
    for(let i=s.length-1;i>=0;i--) if(s[i] !== " ") return i;
    return -1;
  }

  // =========================
  // 3) √Årbol is√≥sceles + tronco centrado en BASE REAL (marca azul)
  // =========================
  function buildTreeLines(h){
    const width = 2*h - 1;
    const lines = [];

    // estrella
    lines.push(centerLine("^", width));

    // copa is√≥sceles
    for(let i=1;i<=h;i++){
      const leafCount = 2*i - 1;
      const spaces = (width - leafCount) / 2;

      let row = " ".repeat(spaces);
      for(let k=0;k<leafCount;k++){
        const pick = (i*13 + k*7) % 12;
        row += (pick === 0 || pick === 5) ? "o" : "*";
      }
      row += " ".repeat(spaces);
      lines.push(row);
    }

    // ‚úÖ Tronco centrado sobre la BASE REAL (√∫ltima fila de hojas)
    const baseLine = lines[lines.length - 1]; // √∫ltima fila de hojas
    const left = baseLine.search(/\S/);       // primer visible
    const right = rightMostNonSpaceIndex(baseLine); // √∫ltimo visible
    const baseCenter = Math.floor((left + right) / 2);

    const trunkStr = "mWm";
    const trunkWidth = trunkStr.length;
    const trunkStart = baseCenter - Math.floor(trunkWidth / 2);

    for(let t=0; t<TRUNK_HEIGHT; t++){
      const row = Array(baseLine.length).fill(" ");
      for(let i=0;i<trunkWidth;i++){
        const idx = trunkStart + i;
        if(idx >= 0 && idx < row.length) row[idx] = trunkStr[i];
      }
      lines.push(row.join(""));
    }

    // espacio
    lines.push("");

    // texto centrado al mismo ancho
    lines.push(centerLine(FINAL_LINE_1, width));
    lines.push(centerLine(FINAL_LINE_2, width));

    return { lines, width };
  }

  function colorChar(ch, i, lineIndex, wholeLine){
    if(wholeLine.includes(FINAL_LINE_1) || wholeLine.includes(FINAL_LINE_2)) return "r";
    if(ch === "^") return "y";
    if(ch === "*") return "g";
    if(ch === "o") return ornamentColors[(i + lineIndex*3) % ornamentColors.length];
    if("mW".includes(ch)) return "y";
    return null;
  }

  async function typeTreeLine(line, lineIndex){
    const tree = document.getElementById("tree");
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      const cls = colorChar(ch, i, lineIndex, line);
      const safeChar = (ch === " ") ? "&nbsp;" : esc(ch);
      tree.innerHTML += cls ? `<span class="${cls}">${safeChar}</span>` : safeChar;
      await sleep(CHAR_DELAY_MS);
    }
    tree.innerHTML += "<br/>";
  }

  // =========================
  // 4) M√∫sica: YouTube 10s (m√°s compatible)
  // =========================
  let player = null;
  let stopTimer = null;
  let pendingPlay = false;

  const audioAlert = document.getElementById("audioAlert");
  const ytOpen = document.getElementById("ytOpen");
  const retryAudio = document.getElementById("retryAudio");
  ytOpen.href = `https://www.youtube.com/watch?v=${YT_VIDEO_ID}`;

  function showAudioAlert(){ audioAlert.style.display = "flex"; }
  function hideAudioAlert(){ audioAlert.style.display = "none"; }

  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player("ytplayer", {
      height:"0",
      width:"0",
      videoId: YT_VIDEO_ID,
      playerVars: {
        autoplay: 0,
        controls: 0,
        rel: 0,
        modestbranding: 1,
        playsinline: 1,
        origin: location.origin
      },
      events: {
        onReady: () => {
          if(pendingPlay){
            pendingPlay = false;
            playMusic10s();
          }
        }
      }
    });
  };

  function stopMusic(){
    if(stopTimer) clearTimeout(stopTimer);
    stopTimer = null;
    try{ if(player) player.stopVideo(); }catch(e){}
  }

  function playMusic10s(){
    const toggle = document.getElementById("musicToggle");
    if(!toggle.checked) return;

    hideAudioAlert();
    stopMusic();

    if(!player || typeof player.playVideo !== "function"){
      pendingPlay = true;
      showAudioAlert();
      return;
    }

    try{
      player.seekTo(MUSIC_START_S, true);
      player.unMute();
      player.setVolume(80);
      player.playVideo();

      // reintento r√°pido (Safari/Firefox a veces lo necesita)
      setTimeout(() => {
        try{
          player.unMute();
          player.setVolume(80);
          player.playVideo();
        }catch(e){}
      }, 300);

      // detector: si no qued√≥ en "playing", avisamos
      setTimeout(() => {
        try{
          const state = player.getPlayerState(); // 1 = playing
          const muted = player.isMuted && player.isMuted();
          if(state !== 1 || muted) showAudioAlert();
        }catch(e){
          showAudioAlert();
        }
      }, 900);

      const durationMs = Math.max(0, (MUSIC_END_S - MUSIC_START_S) * 1000);
      stopTimer = setTimeout(() => {
        try{ player.stopVideo(); }catch(e){}
      }, durationMs);
    }catch(e){
      showAudioAlert();
    }
  }

  document.getElementById("musicToggle").addEventListener("change", (e) => {
    if(!e.target.checked) stopMusic();
  });

  retryAudio.addEventListener("click", (e) => {
    e.preventDefault();
    playMusic10s();
  });

  // =========================
  // 5) RUN
  // =========================
  async function run(){
    const btn = document.getElementById("runBtn");
    const hint = document.getElementById("hintText");
    const tree = document.getElementById("tree");
    const log = document.getElementById("log");

    btn.disabled = true;
    hint.textContent = "Ejecutando‚Ä¶ ‚ú®";
    tree.innerHTML = "";
    log.textContent = "";

    logLine("> RUN pressed ‚úÖ");
    logLine("> initializing christmas_tree.exe");
    await sleep(200);
    logLine("> compiling magic...");
    await sleep(200);
    logLine("> rendering tree...");
    await sleep(250);

    const { lines } = buildTreeLines(TREE_HEIGHT);
    for(let i=0;i<lines.length;i++){
      await typeTreeLine(lines[i], i);
      await sleep(LINE_PAUSE_MS);
    }

    hint.textContent = "üéÅ Listo. Feliz Navidad.";
  }

  document.getElementById("runBtn").addEventListener("click", () => {
    playMusic10s(); // YouTube 10s
    run();
  });
</script>
</body>
</html>
